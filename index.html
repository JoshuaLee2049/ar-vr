// --- DOM å…ƒç´ èˆ‡ç‹€æ…‹ ---
Â  const chatArea = document.getElementById('chatArea');
Â  const messageInput = document.getElementById('messageInput');
Â  const sendBtn = document.getElementById('sendBtn');
Â  const cameraBtn = document.getElementById('cameraBtn');
Â  const shutterOverlay = document.getElementById('shutterOverlay');
Â  const glitchScreen = document.getElementById('glitchScreen');
Â  const chatInterface = document.getElementById('chatInterface');
Â  const glitchText = document.getElementById('glitchText');

Â  // 0=æœªé–‹å§‹, 1=é–‹å ´ä¸­, 2=ç­‰å¾…è»Šç¥¨ä¸»äººè³‡è¨Š(æ–‡å­—RAG), 3=ç­‰å¾…æ‹ç…§(å¤šæ¨¡æ…‹é©—è­‰), 4=å®Œæˆ
Â  let gameState = 0;Â 
Â  let isNpcTyping = false;Â 

Â  // --- è¼”åŠ©å‡½å¼ ---

Â  function getCurrentTime() {
Â  Â  const now = new Date();
Â  Â  return `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
Â  }
Â  function generateRandomChars(length) {
Â  Â  let chars = "!@#$%^&*()_+-=[]{}|;:,.<>?";
Â  Â  let result = "";
Â  Â  for (let i = 0; i < length; i++) { result += chars.charAt(Math.floor(Math.random() * chars.length)); }
Â  Â  return result;
Â  }
Â  function scrollToBottom() { chatArea.scrollTop = chatArea.scrollHeight; }

Â  // ç™¼é€è¨Šæ¯ (Type: 'me' æˆ– 'other')
Â  function addMessage(type, text, isImage = false, forceNpcName = false) {
Â  Â  const row = document.createElement('div');
Â  Â  row.className = `msg-row`;
Â  Â  const time = getCurrentTime();

Â  Â  let contentHtml = `<div class="bubble">${text}</div>`;
Â  Â  if (isImage) {
Â  Â  Â  contentHtml = `<div class="bubble" style="padding: 5px;"><img src="${text}" class="ticket-img"></div>`;
Â  Â  }

Â  Â  if (type === 'me') {
Â  Â  Â  row.classList.add('me');
Â  Â  Â  row.innerHTML = `<div class="meta-info"><span class="read-status">å·²è®€</span><span>${time}</span></div><div class="msg-content">${contentHtml}</div>`;
Â  Â  } else {
Â  Â  Â  row.classList.add('other');
Â  Â  Â  const senderName = forceNpcName ? "ç«™é•· (è¨Šè™Ÿå¾®å¼±)" : "ç«™é•·";
Â  Â  Â  row.innerHTML = `<div class="avatar" style="background-image: url('https://api.dicebear.com/7.x/avataaars/svg?seed=StationMaster&top=hat');"></div><div style="flex:1;"><div class="sender-name">${senderName}</div>${contentHtml}</div><div class="meta-info"><span>${time}</span></div>`;
Â  Â  }

Â  Â  chatArea.appendChild(row);
Â  Â  void row.offsetWidth; // ç¢ºä¿å‹•ç•«è§¸ç™¼
Â  Â  row.classList.add('show');
Â  Â  scrollToBottom();
Â  }

Â  // é¡¯ç¤ºç³»çµ±æç¤º
Â  function addSystemMessage(text, isThinking = false) {
Â  Â  const div = document.createElement('div');
Â  Â  div.className = 'system-card' + (isThinking ? ' thinking-dots' : '');
Â  Â  div.textContent = text;
Â  Â  chatArea.appendChild(div);
Â  Â  scrollToBottom();
Â  Â  return div;
Â  }

Â  // --- Phase 1: å•Ÿå‹•é–‹å ´å‹•ç•« ---
Â  function startSignalAcquisition() {
Â  Â  gameState = 1; // è¨­ç½®ç‚ºé–‹å ´ä¸­
Â  Â  let steps = [
Â  Â  Â  "SYSTEM_OVERRIDE...", "æ­£åœ¨æœå°‹ 1935 å¹´é »æ®µ...", "è¨Šè™ŸåŒæ­¥ç‡ 48%...", "è¨Šè™ŸåŒæ­¥ç‡ 92%...", "âš ï¸ åµæ¸¬åˆ°æ±‚æ•‘è¨Šè™Ÿ"
Â  Â  ];
Â  Â  let stepIndex = 0;
Â  Â  let interval = setInterval(() => {
Â  Â  Â  if (stepIndex < steps.length) {
Â  Â  Â  Â  glitchText.innerHTML = steps[stepIndex] + "<br>" + generateRandomChars(10);
Â  Â  Â  Â  stepIndex++;
Â  Â  Â  } else {
Â  Â  Â  Â  clearInterval(interval);
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  glitchScreen.style.opacity = '0';
Â  Â  Â  Â  Â  setTimeout(startPhase2, 1000); // 1ç§’å¾Œåˆ‡æ›åˆ°èŠå¤©
Â  Â  Â  Â  }, 1000);
Â  Â  Â  }
Â  Â  }, 800);
Â  }

Â  // --- Phase 2: ä»»å‹™æ´¾ç™¼ (Agent) ---
Â  function startPhase2() {
Â  Â  glitchScreen.style.display = 'none';
Â  Â  chatInterface.style.opacity = '1';
Â  Â  sendBtn.disabled = false; // è§£é–å‚³é€æŒ‰éˆ•
Â  Â  gameState = 2; // é€²å…¥ç­‰å¾…è³‡è¨Šéšæ®µ (ç­‰å¾… RAG è§¸ç™¼)

Â  Â  // åŠ‡æœ¬
Â  Â  setTimeout(() => addMessage("other", "æ»‹...æ»‹...è½å¾—åˆ°å—ï¼Ÿæ‹œè¨—ï¼æˆ‘æ˜¯å‹èˆˆè»Šç«™çš„ç«™é•·ï¼Œè¢«å›°åœ¨ 1935 å¹´ï¼", false, true), 500);
Â  Â  setTimeout(() => addMessage("other", "é€™å¼µæ˜¯æœ€å¾Œä¸€ç­è»Šç¥¨...æŒç¥¨äººå¤±è¹¤äº†ã€‚ä¸Šé¢å¯«è‘—ã€Œè‡ºä¸­ã€ï¼", false, true), 2000);
Â  Â  setTimeout(() => {
Â  Â  Â  addMessage("other", "https://images.unsplash.com/photo-1516533075015-a3838415dbc3?auto=format&fit=crop&q=80&w=300", 'other', true); // æ¨¡æ“¬è»Šç¥¨åœ–ç‰‡
Â  Â  Â  addMessage("other", "ç¾åœ¨çš„è‡ºä¸­...æ˜¯ä¸æ˜¯é•·å¾—ä¸ä¸€æ¨£äº†ï¼Ÿè»Šç¥¨ä¸»äººå¯èƒ½åœ¨é‚£é‚Šã€‚è«‹ä½ ...ç”¨ä½ å€‘æ™‚ä»£çš„ç›¸æ©Ÿï¼Œæ‹ä¸€å¼µè»Šç¥¨ç›®çš„åœ°ï¼ˆè‡ºä¸­ï¼‰çš„ **åœ°æ¨™** ç…§ç‰‡çµ¦æˆ‘ï¼");
Â  Â  }, 4000);
Â  }

Â  // --- Phase 3: å¯¦å¢ƒè§£è¬ (Multimodal + RAG + Agent) ---

Â  // è™•ç†æ–‡å­—è¼¸å…¥ (RAG)
Â  messageInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSend(); });
Â  sendBtn.addEventListener('click', handleSend);
Â Â 
Â  function handleSend() {
Â  Â  const text = messageInput.value.trim();
Â  Â  if (!text || isNpcTyping) return;
Â  Â Â 
Â  Â  addMessage('me', text);
Â  Â  messageInput.value = '';
Â  Â Â 
Â  Â  // é€²å…¥ AI é‚è¼¯åˆ¤æ–·
Â  Â  isNpcTyping = true;
Â  Â  setTimeout(() => { processTextLogic(text); }, 1500);
Â  }

Â  function processTextLogic(text) {
Â  Â  if (gameState === 2) {
Â  Â  Â  if (text.includes("è‡ºä¸­") || text.includes("å°ä¸­") || text.includes("åœ°æ¨™") || text.includes("æ‹ç…§")) {
Â  Â  Â  Â  addSystemMessage("âœ… Agent åˆ¤æ–·ï¼šç†è§£ä»»å‹™ç›®æ¨™");
Â  Â  Â  Â  addMessage("å¾ˆå¥½ï¼æˆ‘çŸ¥é“ä½ å€‘ç¾åœ¨çš„æŠ€è¡“å¾ˆå²å®³ã€‚è«‹é»æ“Šå·¦ä¸‹è§’çš„ **ğŸ“· ç›¸æ©ŸæŒ‰éˆ•**ï¼Œæ‹ä¸€å¼µè‡ºä¸­çš„åœ°æ¨™ç…§ç‰‡å‚³çµ¦æˆ‘ï¼", 'other');
Â  Â  Â  Â  gameState = 3; // ğŸ’¥ ä¿®æ­£ï¼šåªæœ‰åœ¨æ–‡å­—ç¢ºèªå¾Œæ‰é€²å…¥æ‹ç…§ç‹€æ…‹
Â  Â  Â  } else if (text.includes("åœ°éœ‡") || text.includes("1935")) {
Â  Â  Â  Â  // RAG æ¨¡æ“¬
Â  Â  Â  Â  const thinkingMsg = addSystemMessage("ğŸ” RAG è³‡æ–™åº«æª¢ç´¢ä¸­ï¼š1935 åœ°éœ‡ç´€éŒ„...", true);
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  thinkingMsg.remove();
Â  Â  Â  Â  Â  addMessage("other", "é‚£å ´éœ‡å‹•...æˆ‘æ°¸ç”Ÿé›£å¿˜ã€‚æ ¹æ“šç´€éŒ„ï¼Œé¾é¨°æ–·æ©‹ä¹Ÿæ˜¯é‚£æ™‚å€™éœ‡æ¯€çš„ã€‚ä½†è»Šç¥¨çš„ç·šç´¢åœ¨è‡ºä¸­ï¼åˆ¥åˆ†å¿ƒï¼");
Â  Â  Â  Â  }, 3000);
Â  Â  Â  } else {
Â  Â  Â  Â  addMessage("æˆ‘è½ä¸å¤ªæ¸…æ¥š...è¨Šè™Ÿå¹²æ“¾å¾ˆåš´é‡ã€‚å°ˆæ³¨åœ¨è»Šç¥¨å’Œç›®çš„åœ°ï¼", 'other');
Â  Â  Â  }
Â  Â  } else if (gameState === 3) {
        addMessage("æˆ‘ç¾åœ¨éœ€è¦çš„æ˜¯ã€Œå½±åƒè­‰æ“šã€ï¼è«‹ç”¨ç›¸æ©Ÿæ‹ä¸‹ä¾†ï¼", 'other');
    }
Â  Â  isNpcTyping = false;
Â  }

Â  // è™•ç†æ‹ç…§ (Multimodal)
Â  cameraBtn.addEventListener('click', () => {
Â  Â  if (gameState !== 3 || isNpcTyping) {
            if (gameState < 3) addMessage("è«‹å…ˆç”¨æ–‡å­—ç¢ºèªä½ ç†è§£ä»»å‹™ç›®æ¨™ï¼", 'other');
            return;
        }
Â  Â Â 
Â  Â  // é–ƒå…‰å‹•ç•«
Â  Â  shutterOverlay.classList.remove('flash-active');
Â  Â  void shutterOverlay.offsetWidth;
Â  Â  shutterOverlay.classList.add('flash-active');
Â  Â Â 
Â  Â  isNpcTyping = true;
Â  Â Â 
Â  Â  setTimeout(() => {
Â  Â  Â  // æ¨¡æ“¬ä¸Šå‚³è‡ºä¸­åœ°æ¨™ (ä¾‹å¦‚ï¼šè‡ºä¸­ç«è»Šç«™)
Â  Â  Â  addMessage('me', 'ğŸ“· å·²å‚³é€ç…§ç‰‡');
Â  Â  Â Â 
Â  Â  Â  const multimodalMsg = addSystemMessage("ğŸ‘ï¸ Multimodal AI æ­£åœ¨è§£æå½±åƒç‰¹å¾µ...", true);

Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  multimodalMsg.remove();
Â  Â  Â  Â  addSystemMessage("âœ… å½±åƒè¾¨è­˜ï¼šè‡ºä¸­ç«è»Šç«™èˆŠç«™ (ä¿¡å¿ƒåº¦ 95%)");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Agent æ ¹æ“šçµæœç”ŸæˆåŠ‡æœ¬
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  addMessage("other", "å•Šï¼é€™æ˜¯...è‡ºä¸­è»Šç«™ï¼å®ƒé•·å¾—å’Œä»¥å‰ä¸å¤ªä¸€æ¨£äº†ï¼ä¸éé€™å€‹å»ºç¯‰é¢¨æ ¼æˆ‘èªå¾—å‡ºä¾†ï¼");
Â  Â  Â  Â  Â  addMessage("other", "æ ¹æ“šæˆ‘çš„ç´€éŒ„ï¼Œè‡ºä¸­è»Šç«™çš„è¨­è¨ˆå¸«æ˜¯è¾°é‡é‡‘å¾çš„å­¸ç”Ÿã€‚ä½ æ‰¾åˆ°äº†è»Šç¥¨ä¸»äººçš„ç·šç´¢äº†ï¼");
Â  Â  Â  Â  Â  addMessage("other", "ğŸ‰ **æ­å–œï¼** ç²å¾— **æ™‚ç©ºåµæ¢** ç¨±è™Ÿã€‚æ–°çš„ç·šç´¢å·²æ›´æ–°ï¼");
Â  Â  Â  Â  Â  gameState = 4; // ä»»å‹™å®Œæˆ
Â  Â  Â  Â  Â  isNpcTyping = false;
Â  Â  Â  Â  }, 1500);
Â  Â  Â  }, 3000); // æ¨¡æ“¬è§£ææ™‚é–“
Â  Â  }, 400);
Â  });

Â  // --- å•Ÿå‹•ç¨‹åº ---
Â  startSignalAcquisition();

            </script>
