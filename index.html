<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>City RPG: èˆŠå±±ç·šæ™‚ç©ºæ¢éšª - è‹—æ —æ•´åˆç‰ˆ + RAG + è¨˜æ†¶NPC</title>

<style>
  body{background-color:#000;margin:0;font-family:'PingFang TC','Microsoft JhengHei',monospace;overflow:hidden;height:100vh;display:flex;justify-content:center;align-items:stretch}
  .phone-frame{width:100%;max-width:450px;height:100%;position:relative;overflow:hidden;background:#111}

  /* Phase 1 */
  .signal-overlay{position:absolute;inset:0;background:repeating-linear-gradient(0deg,rgba(0,0,0,0.15) 1px,transparent 2px);pointer-events:none;z-index:100;animation:scanline 8s linear infinite}
  .glitch-screen{position:absolute;inset:0;background:#000;color:#0f0;z-index:50;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:20px;transition:opacity 1s}
  .glitch-text{font-size:1.2em;text-shadow:2px 0 red,-2px 0 blue;animation:glitch .3s cubic-bezier(.25,.46,.45,.94) both infinite}

  /* Phase 2/3 */
  .chat-interface{width:100%;height:100%;display:flex;flex-direction:column;background-image:linear-gradient(rgba(0,0,0,.6),rgba(0,0,0,.6)),url('https://images.unsplash.com/photo-1517414628890-5348538e8bf0?auto=format&fit=crop&q=80&w=800');background-size:cover;background-position:center;opacity:0;transition:opacity 1s}
  .header{background:rgba(0,0,0,.8);color:#fff;padding:15px;display:flex;align-items:center;border-bottom:1px solid #333}
  .chat-area{flex:1;padding:20px 12px;overflow-y:auto;display:flex;flex-direction:column;gap:18px;scroll-behavior:smooth}

  .msg-row{display:flex;align-items:flex-end;margin-bottom:5px;opacity:0;transform:translateY(10px);transition:all .5s}
  .msg-row.show{opacity:1;transform:translateY(0)}
  .msg-row.me{justify-content:flex-end}
  .msg-row.other{justify-content:flex-start}

  .avatar{width:42px;height:42px;border-radius:50%;border:2px solid #fff;margin-right:10px;background-size:cover;filter:sepia(.3);flex-shrink:0}
  .sender-name{color:#ccc;font-size:.8em;margin-bottom:4px;margin-left:2px;text-shadow:1px 1px 2px black}

  .bubble{position:relative;padding:10px 14px;border-radius:18px;font-size:.95em;line-height:1.5;max-width:240px;box-shadow:0 2px 4px rgba(0,0,0,.3);word-break:break-word}
  .msg-row.other .bubble{background:rgba(255,255,255,.95);color:#333;border-top-left-radius:2px}
  .msg-row.other .bubble::before{content:"";position:absolute;left:-8px;top:0;border-right:12px solid rgba(255,255,255,.95);border-bottom:10px solid transparent}
  .msg-row.me .bubble{background:#98e165;color:#000;border-top-right-radius:2px}
  .msg-row.me .bubble::before{content:"";position:absolute;right:-8px;top:0;border-left:12px solid #98e165;border-bottom:10px solid transparent}

  .meta-info{font-size:.7em;color:rgba(255,255,255,.55);margin:0 8px;white-space:nowrap}
  .read-status{margin-right:6px;opacity:.9}

  .ticket-img{width:100%;border-radius:4px;border:2px solid #777;filter:sepia(.8) contrast(1.2);display:block}

  .system-card{align-self:center;background:rgba(13,100,100,.7);color:#fff;padding:5px 15px;border-radius:20px;font-size:.75em;margin:10px 0;border:1px solid rgba(255,255,255,.3);backdrop-filter:blur(4px)}
  .thinking-dots::after{content:"...";display:inline-block;overflow:hidden;vertical-align:bottom;width:0;animation:dots 1.2s steps(4,end) infinite}

  .input-bar{background:#222;padding:10px;border-top:1px solid #444;display:flex;align-items:center;gap:10px}
  .icon-btn{font-size:1.4em;padding:5px;cursor:pointer;color:#ccc;user-select:none}
  .text-input{flex:1;background:#333;border:none;padding:10px 15px;border-radius:20px;outline:none;font-size:16px;color:white}
  .send-btn{color:#5dade2;font-weight:bold;cursor:pointer;border:none;background:none;padding:5px}
  .send-btn:disabled{opacity:.4;cursor:not-allowed}

  .shutter-flash{position:absolute;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:999}
  .flash-active{animation:flashAnim .3s ease-out forwards}

  @keyframes scanline{0%{background-position:0% 0%}100%{background-position:0% 100%}}
  @keyframes glitch{0%{transform:translate(0)}40%{transform:translate(2px,-2px)}80%{transform:translate(-2px,2px)}100%{transform:translate(0)}}
  @keyframes flashAnim{0%{opacity:0}30%{opacity:.9}100%{opacity:0}}
  @keyframes dots{to{width:1.2em}}
</style>
</head>

<body>
  <div class="phone-frame">
    <div class="shutter-flash" id="shutterOverlay"></div>
    <div class="signal-overlay"></div>

    <div class="glitch-screen" id="glitchScreen">
      <div style="font-size:3em; margin-bottom:20px;">âš ï¸</div>
      <div class="glitch-text" id="glitchText">é€£ç·šå»ºç«‹ä¸­...<br>æ¥æ”¶åˆ°æœªé »æ®µè¨Šè™Ÿ...</div>
    </div>

    <div class="chat-interface" id="chatInterface">
      <div class="header">
        <div style="flex:1;">ğŸ“¶ ä¸æ˜è¨Šè™Ÿæº</div>
        <div style="font-size:0.8em; color:#e74c3c;">é€£ç·šä¸ç©©å®š</div>
      </div>

      <div class="chat-area" id="chatArea"></div>

      <div class="input-bar">
        <div class="icon-btn" id="cameraBtn">ğŸ“·</div>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">
        <div class="icon-btn">ï¼‹</div>
        <input type="text" class="text-input" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯â€¦ï¼ˆRAG:å•é¡Œ / è³‡æ–™åº« / æ¸…é™¤è¨˜æ†¶ï¼‰">
        <button class="send-btn" id="sendBtn" disabled>å‚³é€</button>
      </div>
    </div>
  </div>

<script>
  // ===== å¯æ›ä¸»é¡Œçš„æ ¸å¿ƒç›®æ¨™ =====
  const TARGET_CITY = "è‹—æ —";
  const TARGET_AREA = "ä¸‰ç¾©";
  const TARGET_LANDMARK = "é¾é¨°æ–·æ©‹";

  // DOM
  const chatArea = document.getElementById('chatArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const cameraBtn = document.getElementById('cameraBtn');
  const cameraInput = document.getElementById('cameraInput');
  const shutterOverlay = document.getElementById('shutterOverlay');
  const glitchScreen = document.getElementById('glitchScreen');
  const chatInterface = document.getElementById('chatInterface');
  const glitchText = document.getElementById('glitchText');

  // 0=æœªé–‹å§‹, 1=é–‹å ´ä¸­, 2=ç­‰å¾…æ–‡å­—ç¢ºèª, 3=ç­‰å¾…æ‹ç…§, 4=å®Œæˆ
  let gameState = 0;
  let isNpcTyping = false;

  // ===============================
  // âœ… è¨˜æ†¶ NPCï¼ˆlocalStorageï¼‰
  // ===============================
  const MEMORY_KEY = "old_mountain_npc_memory_v1";

  function defaultMemory() {
    return {
      progress: { confirmedGoal: false, photoSent: false, finished: false },
      stats: { offTopicCount: 0, lastHintAt: 0 },
      context: { playerName: null, lastUserText: "", lastUserAt: Date.now() }
    };
  }

  function loadMemory() {
    try {
      const raw = localStorage.getItem(MEMORY_KEY);
      if (!raw) return defaultMemory();
      const m = JSON.parse(raw);
      const d = defaultMemory();
      return {
        ...d, ...m,
        progress: { ...d.progress, ...(m.progress || {}) },
        stats: { ...d.stats, ...(m.stats || {}) },
        context: { ...d.context, ...(m.context || {}) },
      };
    } catch {
      return defaultMemory();
    }
  }

  let npcMemory = loadMemory();

  function saveMemory() {
    try { localStorage.setItem(MEMORY_KEY, JSON.stringify(npcMemory)); } catch {}
  }

  function clearMemory() {
    npcMemory = defaultMemory();
    try { localStorage.removeItem(MEMORY_KEY); } catch {}
  }

  function rememberUser(text) {
    npcMemory.context.lastUserText = text;
    npcMemory.context.lastUserAt = Date.now();
    const m = text.match(/æˆ‘(å«|æ˜¯)\s*([A-Za-z0-9\u4e00-\u9fff]{1,12})/);
    if (m && m[2]) npcMemory.context.playerName = m[2];
    saveMemory();
  }

  function markProgress(key, value = true) {
    npcMemory.progress[key] = value;
    saveMemory();
  }

  function canHintNow() {
    const now = Date.now();
    return (now - (npcMemory.stats.lastHintAt || 0)) > 12000;
  }

  function recordHint() {
    npcMemory.stats.lastHintAt = Date.now();
    saveMemory();
  }

  // ===============================
  // âœ… åŸºæœ¬ UI / å®‰å…¨
  // ===============================
  const pad2 = (n) => String(n).padStart(2, '0');

  function getCurrentTime(){
    const now = new Date();
    return `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
  }

  function generateRandomChars(length){
    const chars = "!@#$%^&*()_+-=[]{}|;:,.<>?";
    let result = "";
    for(let i=0;i<length;i++) result += chars.charAt(Math.floor(Math.random()*chars.length));
    return result;
  }

  function scrollToBottom(){ chatArea.scrollTop = chatArea.scrollHeight; }

  function escapeHtml(str){
    return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function formatText(str){
    const safe = escapeHtml(str);
    return safe.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
  }

  function addMessage(type, text, isImage=false, forceNpcName=false){
    const row = document.createElement('div');
    row.className = 'msg-row';
    const time = getCurrentTime();

    let contentHtml;
    if(isImage){
      contentHtml = `<div class="bubble" style="padding:5px;"><img src="${text}" class="ticket-img" alt="image"></div>`;
    }else{
      contentHtml = `<div class="bubble">${formatText(text)}</div>`;
    }

    if(type === 'me'){
      row.classList.add('me');
      row.innerHTML = `
        <div class="meta-info"><span class="read-status">å·²è®€</span><span>${time}</span></div>
        ${contentHtml}
      `;
    }else{
      row.classList.add('other');
      const senderName = forceNpcName ? "ç«™é•· (è¨Šè™Ÿå¾®å¼±)" : "ç«™é•·";
      row.innerHTML = `
        <div class="avatar" style="background-image:url('https://api.dicebear.com/7.x/avataaars/svg?seed=StationMaster');"></div>
        <div style="flex:1;">
          <div class="sender-name">${senderName}</div>
          ${contentHtml}
        </div>
        <div class="meta-info"><span>${time}</span></div>
      `;
    }

    chatArea.appendChild(row);
    void row.offsetWidth;
    row.classList.add('show');
    scrollToBottom();
  }

  function addSystemMessage(text, isThinking=false){
    const div = document.createElement('div');
    div.className = 'system-card' + (isThinking ? ' thinking-dots' : '');
    div.textContent = text;
    chatArea.appendChild(div);
    scrollToBottom();
    return div;
  }

  function npcSay(text, weak=true){
    addMessage('other', text, false, weak);
  }

  // ===============================
  // âœ… RAG è³‡æ–™åº«ï¼ˆå‰ç«¯ç‰ˆï¼Œå¯æ“´å……ï¼‰
  // ===============================
  const RAG_DB = [
    {
      id: "eq-1935",
      title: "1935 æ–°ç«¹â€“å°ä¸­åœ°éœ‡",
      tags: ["åœ°éœ‡","1935","æ–°ç«¹å°ä¸­","ä¸‰ç¾©","è‹—æ —","éœ‡å¤®","è¦æ¨¡"],
      source: "å½™æ•´",
      text: "1935-04-21 æ¸…æ™¨ç™¼ç”Ÿæ–°ç«¹â€”å°ä¸­åœ°éœ‡ï¼ˆå¸¸è¦‹è³‡æ–™è¨˜è¼‰è¦æ¨¡ç´„ 7 ç´šï¼‰ï¼Œéœ‡å¤®åœ¨ä»Šè‹—æ —ä¸‰ç¾©ä¸€å¸¶ï¼Œé€ æˆé‡å¤§å‚·äº¡èˆ‡æ©‹æ¢ã€éµé“è¨­æ–½æ¯€æã€‚"
    },
    {
      id: "old-mountain-line",
      title: "èˆŠå±±ç·šï¼ˆå‹èˆˆâ€”æ³°å®‰æ®µï¼‰",
      tags: ["èˆŠå±±ç·š","éµé“","éš§é“","å½é“","å¡åº¦","ä¸‰ç¾©","æ³°å®‰","å‹èˆˆ"],
      source: "å½™æ•´",
      text: "èˆŠå±±ç·šæ˜¯ç¸±è²«éµè·¯æ—©æœŸç©¿è¶Šå±±å€çš„é‡è¦è·¯æ®µï¼Œä»¥å¤§å¡åº¦ã€å¤§å½é“èˆ‡å¤šéš§é“èåï¼›å‹èˆˆè»Šç«™æ˜¯è‘—åéµé“æ—…éŠç¯€é»ã€‚"
    },
    {
      id: "shengxing-station",
      title: "å‹èˆˆè»Šç«™ï¼ˆæ­·å²èˆ‡æ—…éŠï¼‰",
      tags: ["å‹èˆˆè»Šç«™","åå…­ä»½","å¤è¹Ÿ","èˆŠå±±ç·š","ä¸‰ç¾©"],
      source: "å½™æ•´",
      text: "å‹èˆˆè»Šç«™ä½æ–¼è‹—æ —ä¸‰ç¾©ï¼Œèˆ‡èˆŠå±±ç·šå·¥ç¨‹å¯†åˆ‡ç›¸é—œï¼Œæ˜¯éµé“æ–‡åŒ–æ™¯é»ï¼›å¸¸è¢«éŠå®¢è¦–ç‚ºèˆŠå±±ç·šçš„ä»£è¡¨æ€§æ“šé»ã€‚"
    },
    {
      id: "longteng-bridge",
      title: "é­šè—¤åª/é¾é¨°æ–·æ©‹ï¼ˆéœ‡ç½è¨˜æ†¶ï¼‰",
      tags: ["é¾é¨°æ–·æ©‹","é­šè—¤åª","æ–·æ©‹","éœ‡æ¯€","æ©‹å¢©","ç£šæ‹±"],
      source: "å½™æ•´",
      text: "é­šè—¤åªæ–·æ©‹åˆç¨±é¾é¨°æ–·æ©‹ï¼Œæ—©æœŸä»¥ç£šæ‹±æ©‹å¢©çµæ§‹è‘—ç¨±ï¼›1935 åœ°éœ‡å¾Œå—ææˆæ–·æ©‹éºæ§‹ï¼Œæˆç‚ºä»Šæ—¥è‘—ååœ°æ¨™ã€‚"
    },
    {
      id: "yutengping-new-bridge",
      title: "é­šè—¤åªæ–°æ©‹ï¼ˆéœ‡å¾Œå¾©é€šï¼‰",
      tags: ["é­šè—¤åªæ–°æ©‹","1938","é‡å»º","æ–°æ©‹","è€éœ‡"],
      source: "å½™æ•´",
      text: "åœ°éœ‡å¾Œç‚ºæ¢å¾©é€šè¡Œï¼Œå¾ŒçºŒå¦å»ºé­šè—¤åªæ–°æ©‹ï¼ˆå¸¸è¦‹è¨˜è¼‰ 1938 å‰å¾Œå®Œæˆï¼‰ï¼Œèˆ‡èˆŠæ©‹éºæ§‹ä¸¦åˆ—æˆç‚ºç¶“å…¸æ™¯è§€ã€‚"
    }
  ];

  function normalizeText(s){
    return (s || "")
      .toLowerCase()
      .replace(/[\u3000\s]+/g, " ")
      .replace(/[ï¼Œã€‚ã€ã€Šã€‹ã€Œã€ã€ã€ï¼ˆï¼‰()ã€ã€‘\[\]{}<>!ï¼?ï¼Ÿ:ï¼š;ï¼›ã€"'\-_/\\|@#$%^&*+=~`]/g, " ")
      .trim();
  }

  function isCJK(ch){
    const code = ch.charCodeAt(0);
    return (code >= 0x4E00 && code <= 0x9FFF) || (code >= 0x3400 && code <= 0x4DBF);
  }

  function tokenize(query){
    const raw = normalizeText(query);
    if(!raw) return [];
    const words = raw.split(/\s+/).filter(Boolean);

    const cjkOnly = raw.replace(/[a-z0-9\s]/g, "");
    const cjkChars = [...cjkOnly].filter(ch => isCJK(ch));
    const bigrams = [];
    for(let i=0;i<cjkChars.length-1;i++){
      bigrams.push(cjkChars[i] + cjkChars[i+1]);
    }
    return [...words, ...bigrams];
  }

  function scoreDoc(query, queryTokens, doc){
    const qNorm = normalizeText(query);
    const docText = normalizeText(doc.title + " " + doc.tags.join(" ") + " " + doc.text);
    const docTokens = new Set(tokenize(docText));

    let score = 0;
    for(const t of queryTokens){
      if(!t) continue;
      if(docTokens.has(t)) score += 2;
      if(docText.includes(t)) score += 1;
    }

    for(const tag of doc.tags){
      const tagNorm = normalizeText(tag);
      if(tagNorm && qNorm.includes(tagNorm)) score += 2;
    }
    return score;
  }

  function ragSearch(query, k=3){
    const qTokens = tokenize(query);
    if(qTokens.length === 0) return [];
    return RAG_DB
      .map(doc => ({ doc, score: scoreDoc(query, qTokens, doc) }))
      .filter(x => x.score > 0)
      .sort((a,b) => b.score - a.score)
      .slice(0, k);
  }

  function ragSnippet(text, maxLen=90){
    const s = (text || "").replace(/\s+/g, " ").trim();
    return s.length > maxLen ? s.slice(0, maxLen) + "â€¦" : s;
  }

  function buildRagReply(query, hits){
    if(!hits.length){
      return "æˆ‘ç¿»äº†ç«™å‹™è³‡æ–™åº«ï¼Œä½†é€™å¥é—œéµå­—å¤ªå¼±äº†â€¦\nä½ å¯ä»¥æ”¹æˆï¼š\n- RAG:é¾é¨°æ–·æ©‹ ç‚ºä»€éº¼æœƒæ–·ï¼Ÿ\n- RAG:1935 åœ°éœ‡ éœ‡å¤®åœ¨å“ªï¼Ÿ\n- RAG:èˆŠå±±ç·š æœ‰ä»€éº¼ç‰¹è‰²ï¼Ÿ";
    }
    const lines = hits.map(h => {
      const d = h.doc;
      return `â€¢ ${d.title}\n  ${ragSnippet(d.text)}\n  ï¼ˆä¾†æºï¼š${d.source}ï¼‰`;
    });
    return `ğŸ” æˆ‘å¾ RAG è³‡æ–™åº«æ’ˆåˆ°ä»¥ä¸‹ç·šç´¢ï¼š\n\n${lines.join("\n\n")}\n\nè¦æˆ‘æŠŠé€™äº›è³‡æ–™æ•´ç†æˆã€Œä»»å‹™ç·šç´¢ã€ç‰ˆï¼Œå›æˆ‘ï¼šç·šç´¢æ•´ç†`;
  }

  function listRagTopics(){
    const titles = RAG_DB.map(d => `â€¢ ${d.title}`).join("\n");
    return `ğŸ“š ç›®å‰ RAG è³‡æ–™åº«æ¢ç›®ï¼š\n\n${titles}\n\nä½¿ç”¨æ–¹å¼ï¼š\n- ç›´æ¥æå•ï¼ˆå«ï¼Ÿï¼‰å°±æœƒè§¸ç™¼\n- æˆ–è¼¸å…¥ï¼šRAG:ä½ çš„å•é¡Œ`;
  }

  function isQuestionLike(text){
    if(/[?ï¼Ÿ]/.test(text)) return true;
    const q = ["ä»€éº¼","ç‚ºä½•","ç‚ºä»€éº¼","å¹¾å¹´","åœ¨å“ª","æ€éº¼","å¦‚ä½•","å“ªè£¡","æµ·æ‹”","ç‰¹è‰²","åŸå› "];
    return q.some(k => text.includes(k));
  }

  function runRAG(query, done){
    const t = addSystemMessage(`ğŸ” RAG æª¢ç´¢ä¸­ï¼š${query}`, true);
    setTimeout(() => {
      const hits = ragSearch(query, 3);
      t.remove();

      if(!hits.length){
        addSystemMessage("âš ï¸ RAGï¼šæŸ¥ç„¡å‘½ä¸­ï¼ˆè©¦è©¦çœ‹æ›é—œéµå­—ï¼‰");
      }else{
        addSystemMessage(`âœ… RAG å‘½ä¸­ï¼š${hits.map(x => x.doc.title).join("ã€")}`);
      }

      npcSay(buildRagReply(query, hits), true);
      done();
    }, 650);
  }

  // ===============================
  // âœ… ä¸»å‹•æç¤ºï¼ˆé–’ç½® + å¡é—œï¼‰
  // ===============================
  function startProactiveHints() {
    setInterval(() => {
      if (isNpcTyping) return;
      if (!canHintNow()) return;

      const now = Date.now();
      const idleMs = now - (npcMemory.context.lastUserAt || now);

      // åªæœ‰åœ¨ä»»å‹™å°šæœªçµæŸæ™‚æç¤º
      if (gameState === 2 && !npcMemory.progress.confirmedGoal) {
        if (idleMs > 18000) {
          recordHint();
          npcSay(`ï¼ˆæç¤ºï¼‰ä½ åªè¦å›æˆ‘ä¸€å¥ã€ŒçŸ¥é“äº†ã€æˆ–æåˆ°ã€Œ${TARGET_LANDMARK}/${TARGET_AREA}ã€ï¼Œæˆ‘å°±èƒ½ç¢ºèªä½ ç†è§£ä»»å‹™ï¼Œä¸¦è§£é– ğŸ“· æ‹ç…§ã€‚`);
        }
      }

      if (gameState === 3 && !npcMemory.progress.photoSent) {
        if (idleMs > 18000) {
          recordHint();
          npcSay(`ï¼ˆæç¤ºï¼‰ç¾åœ¨è¦åšçš„æ˜¯ã€Œå½±åƒè­‰æ“šã€ï¼šæŒ‰å·¦ä¸‹è§’ **ğŸ“·** æ‹ä¸‹ **${TARGET_LANDMARK}** ä¸¦å‚³çµ¦æˆ‘ã€‚`);
        }
      }

      if (gameState === 4 && !npcMemory.progress.finished) {
        markProgress("finished", true);
      }
    }, 2000);
  }

  // ===============================
  // Phase 1
  // ===============================
  function startSignalAcquisition(){
    gameState = 1;
    const steps = [
      "SYSTEM_OVERRIDE...",
      "æ­£åœ¨æœå°‹ 1935 å¹´é »æ®µ...",
      "è¨Šè™ŸåŒæ­¥ç‡ 48%...",
      "è¨Šè™ŸåŒæ­¥ç‡ 92%...",
      "âš ï¸ åµæ¸¬åˆ°æ±‚æ•‘è¨Šè™Ÿ"
    ];
    let stepIndex = 0;

    const interval = setInterval(() => {
      if(stepIndex < steps.length){
        glitchText.innerHTML = steps[stepIndex] + "<br>" + generateRandomChars(10);
        stepIndex++;
      }else{
        clearInterval(interval);
        setTimeout(() => {
          glitchScreen.style.opacity = '0';
          setTimeout(startPhase2, 1000);
        }, 1000);
      }
    }, 800);
  }

  // ä¾è¨˜æ†¶æ¢å¾©é€²åº¦ï¼ˆåˆ·æ–°ä¹Ÿä¸æœƒäº‚ï¼‰
  function resumeStateFromMemory(){
    if (npcMemory.progress.finished) return 4;
    if (npcMemory.progress.photoSent) return 3;      // å·²å‚³éç…§ç‰‡ï¼šä»å›åˆ°æ‹ç…§éšæ®µï¼ˆå¯å†å‚³ä¸€æ¬¡ï¼‰
    if (npcMemory.progress.confirmedGoal) return 3;  // å·²ç¢ºèªç›®æ¨™ï¼šå›åˆ°æ‹ç…§éšæ®µ
    return 2;
  }

  // Phase 2ï¼ˆè‹—æ —ä»»å‹™ï¼‰
  function startPhase2(){
    glitchScreen.style.display = 'none';
    chatInterface.style.opacity = '1';
    sendBtn.disabled = false;

    // é¿å…ä¸€é€²ä¾†å°±è¢«ã€Œé–’ç½®æç¤ºã€æ´—ç‰ˆ
    npcMemory.context.lastUserAt = Date.now();
    saveMemory();

    const resume = resumeStateFromMemory();

    if (resume === 4) {
      gameState = 4;
      addSystemMessage("ğŸ§  è¨˜æ†¶æ¢å¾©ï¼šä¸Šæ¬¡é€²åº¦å·²å®Œæˆ");
      npcSay(`æˆ‘è¨˜å¾—ä½ å·²ç¶“å¹«æˆ‘æ‰¾åˆ° **${TARGET_LANDMARK}** çš„ç·šç´¢äº†ã€‚\nä½ ç¾åœ¨å¯ä»¥ç¹¼çºŒå•æˆ‘å•é¡Œï¼ˆå«ï¼ŸæœƒæŸ¥ RAGï¼‰ï¼Œæˆ–è¼¸å…¥ã€Œæ¸…é™¤è¨˜æ†¶ã€é‡ä¾†ã€‚`, true);
      return;
    }

    if (resume === 3) {
      gameState = 3;
      addSystemMessage("ğŸ§  è¨˜æ†¶æ¢å¾©ï¼šå·²ç¢ºèªä»»å‹™ï¼Œç­‰å¾…æ‹ç…§");
      npcSay(`æ»‹â€¦ä½ å›ä¾†äº†ã€‚\nè«‹ç›´æ¥æŒ‰å·¦ä¸‹è§’ **ğŸ“·**ï¼Œæ‹ä¸€å¼µ **${TARGET_LANDMARK}** çš„ç…§ç‰‡å‚³çµ¦æˆ‘ã€‚`, true);
      return;
    }

    // resume === 2ï¼šæ­£å¸¸é–‹å ´
    gameState = 2;

    setTimeout(() => npcSay(`æ»‹...æ»‹...è½å¾—åˆ°å—ï¼Ÿæ‹œè¨—ï¼æˆ‘æ˜¯å‹èˆˆè»Šç«™çš„ç«™é•·ï¼Œè¢«å›°åœ¨ 1935 å¹´ï¼`, true), 500);

    setTimeout(() => {
      npcSay(`é€™å¼µæ˜¯æœ€å¾Œä¸€ç­è»Šç¥¨...æŒç¥¨äººå¤±è¹¤äº†ã€‚ä¸Šé¢å¯«è‘—ã€Œ${TARGET_CITY}ãƒ»${TARGET_AREA}ã€ï¼`, true);
    }, 2000);

    setTimeout(() => {
      addMessage('other', "https://images.unsplash.com/photo-1516533075015-a3838415dbc3?auto=format&fit=crop&q=80&w=300", true, true);
    }, 4000);

    setTimeout(() => {
      npcSay(
        `${TARGET_CITY}ï¼ˆ${TARGET_AREA}ï¼‰ç¾åœ¨...é‚„èªå¾—å‡ºä¾†å—ï¼Ÿ\n` +
        `æ‹œè¨—ä½ ç”¨ä½ å€‘æ™‚ä»£çš„ç›¸æ©Ÿï¼Œæ‹ä¸€å¼µ **${TARGET_LANDMARK}** çš„åœ°æ¨™ç…§ç‰‡å‚³çµ¦æˆ‘ï¼\n\n` +
        `ï¼ˆä½ ä¹Ÿå¯ä»¥ç›´æ¥å•æˆ‘ï¼šä¾‹å¦‚ã€Œ${TARGET_LANDMARK} ç‚ºä»€éº¼æœƒæ–·ï¼Ÿã€æˆ‘æœƒå»ç¿» RAG è³‡æ–™åº«ï¼‰`,
        true
      );
    }, 6000);
  }

  // ===============================
  // Text send
  // ===============================
  messageInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){
      e.preventDefault();
      handleSend();
    }
  });
  sendBtn.addEventListener('click', handleSend);

  function handleSend(){
    const text = messageInput.value.trim();
    if(!text || isNpcTyping) return;

    addMessage('me', text);
    messageInput.value = '';

    // âœ… è¨˜ä½ç©å®¶å…§å®¹
    rememberUser(text);

    // âœ… æŒ‡ä»¤ï¼šæ¸…é™¤è¨˜æ†¶
    if (text === "æ¸…é™¤è¨˜æ†¶" || text.toLowerCase() === "reset") {
      clearMemory();
      npcSay("ï¼ˆå·²é‡ç½®è¨˜æ†¶ï¼‰æˆ‘æš«æ™‚å¿˜æ‰å‰›æ‰çš„é€²åº¦èˆ‡å°è©±è„ˆçµ¡äº†ã€‚é‡æ–°æ•´ç†æˆ–ç¹¼çºŒè¼¸å…¥éƒ½å¯ä»¥é‡æ–°é–‹å§‹ã€‚", true);
      isNpcTyping = false;
      return;
    }

    isNpcTyping = true;
    setTimeout(() => processTextLogic(text), 450);
  }

  function processTextLogic(text){
    const endTurn = () => { isNpcTyping = false; };

    // âœ… å¿«æ·ï¼šåˆ—å‡ºè³‡æ–™åº«
    if(text === "è³‡æ–™åº«" || text.toLowerCase() === "ragç›®éŒ„"){
      npcSay(listRagTopics(), true);
      endTurn();
      return;
    }

    // âœ… æŒ‡ä»¤å¼ï¼šRAG:xxx
    const m = text.match(/^\s*rag\s*[:ï¼š]\s*(.+)$/i);
    if(m && m[1]){
      runRAG(m[1], endTurn);
      return;
    }

    // âœ… ç·šç´¢æ•´ç†ï¼ˆæŠŠæœ€è¿‘ä¸€æ¬¡å•é¡Œ/ä»»å‹™åšå¼•å°ï¼‰
    if(text === "ç·šç´¢æ•´ç†"){
      const n = npcMemory.context.playerName ? ` ${npcMemory.context.playerName}` : "";
      npcSay(
        `å¥½çš„${n}ï¼Œæˆ‘æŠŠç·šç´¢æ•´ç†æˆä»»å‹™å°å¼•ï¼š\n` +
        `1) ç›®æ¨™åœ°æ¨™ï¼š**${TARGET_LANDMARK}**ï¼ˆ${TARGET_CITY}ãƒ»${TARGET_AREA}ï¼‰\n` +
        `2) ç›¸é—œäº‹ä»¶ï¼š1935 åœ°éœ‡ â†’ æ©‹æ¢/éµé“å—æï¼ˆå¯å•æˆ‘ï¼šRAG:1935 åœ°éœ‡ï¼‰\n` +
        `3) ä¸‹ä¸€æ­¥ï¼šæŒ‰ **ğŸ“·** æ‹åœ°æ¨™å‚³æˆ‘ â†’ æˆ‘æ›´æ–°ç·šç´¢\n\n` +
        `è¦æˆ‘æä¾›ã€Œæ‹ç…§è§’åº¦å»ºè­°ã€å›æˆ‘ï¼šæ‹ç…§å»ºè­°`,
        true
      );
      endTurn();
      return;
    }

    if(text === "æ‹ç…§å»ºè­°"){
      npcSay(
        `æ‹ **${TARGET_LANDMARK}** çš„å°å»ºè­°ï¼š\n` +
        `â€¢ ç«™åœ¨èƒ½åŒæ™‚æ‹åˆ°ã€Œç£šæ‹±æ©‹å¢©ã€èˆ‡ã€Œç¼ºå£ã€çš„ä½ç½®\n` +
        `â€¢ ç›¡é‡é¿å…é€†å…‰ï¼ˆèƒŒå°å¤ªé™½æˆ–ç­‰é›²é®ï¼‰\n` +
        `â€¢ è¿‘æ™¯æ”¾å…¥æ¬„æ†/æ­¥é“ä¸€è§’ï¼Œè¾¨è­˜æ›´å®¹æ˜“`,
        true
      );
      endTurn();
      return;
    }

    // ---------------------------
    // ä¾ç‹€æ…‹è™•ç† + è¨˜æ†¶å¼•å°
    // ---------------------------
    if(gameState === 2){
      const ok =
        text.includes(TARGET_CITY) ||
        text.includes(TARGET_AREA) ||
        text.includes("å‹èˆˆ") ||
        text.includes("é¾é¨°") ||
        text.includes("æ–·æ©‹") ||
        text.includes("åœ°æ¨™") ||
        text.includes("æ‹ç…§") ||
        text.includes("çŸ¥é“äº†");

      // åƒæå•ï¼šå…ˆ RAGï¼ˆä¸é˜»æ–·ä»»å‹™ï¼‰
      if(isQuestionLike(text)){
        if(ok){
          addSystemMessage("âœ… Agent åˆ¤æ–·ï¼šç†è§£ä»»å‹™ç›®æ¨™");
          npcSay(`å¤ªå¥½äº†ï¼è«‹é»æ“Šå·¦ä¸‹è§’çš„ **ğŸ“· ç›¸æ©ŸæŒ‰éˆ•**ï¼Œæ‹ä¸€å¼µ **${TARGET_LANDMARK}** çš„ç…§ç‰‡å‚³çµ¦æˆ‘ï¼`, true);
          gameState = 3;
          markProgress("confirmedGoal", true);
          npcMemory.stats.offTopicCount = 0; saveMemory();

          runRAG(text, endTurn);
          return;
        }
        runRAG(text, endTurn);
        return;
      }

      if(ok){
        addSystemMessage("âœ… Agent åˆ¤æ–·ï¼šç†è§£ä»»å‹™ç›®æ¨™");
        npcSay(`å¤ªå¥½äº†ï¼è«‹é»æ“Šå·¦ä¸‹è§’çš„ **ğŸ“· ç›¸æ©ŸæŒ‰éˆ•**ï¼Œæ‹ä¸€å¼µ **${TARGET_LANDMARK}** çš„ç…§ç‰‡å‚³çµ¦æˆ‘ï¼`, true);
        gameState = 3;
        markProgress("confirmedGoal", true);
        npcMemory.stats.offTopicCount = 0; saveMemory();
        endTurn();
        return;
      }

      // å¡é—œåµæ¸¬ï¼ˆåé¡Œ 2 æ¬¡å°±ä¸»å‹•å¼•å°ï¼‰
      npcMemory.stats.offTopicCount = (npcMemory.stats.offTopicCount || 0) + 1;
      saveMemory();
      npcSay(`æˆ‘è½ä¸å¤ªæ¸…æ¥š...è¨Šè™Ÿå¹²æ“¾å¾ˆåš´é‡ã€‚å°ˆæ³¨åœ¨ ${TARGET_CITY}ï¼ˆ${TARGET_AREA}ï¼‰å’Œ ${TARGET_LANDMARK}ï¼`, true);

      if (npcMemory.stats.offTopicCount >= 2 && canHintNow()) {
        recordHint();
        npcMemory.stats.offTopicCount = 0; saveMemory();
        npcSay(`ï¼ˆå¼•å°ï¼‰ä½ åªè¦å›æˆ‘ã€ŒçŸ¥é“äº†ã€æˆ–æ‰“å‡ºã€Œ${TARGET_LANDMARK}ã€ï¼Œæˆ‘å°±èƒ½è§£é– ğŸ“· ä»»å‹™ã€‚`, true);
      }

      endTurn();
      return;
    }

    if(gameState === 3){
      if(isQuestionLike(text)){
        runRAG(text, endTurn);
        return;
      }
      npcSay(`æˆ‘ç¾åœ¨éœ€è¦çš„æ˜¯ã€Œå½±åƒè­‰æ“šã€ï¼è«‹æŒ‰ **ğŸ“·** æ‹ä¸‹ **${TARGET_LANDMARK}**ï¼`, true);
      endTurn();
      return;
    }

    if(gameState === 4){
      if(isQuestionLike(text)){
        runRAG(text, endTurn);
        return;
      }
      npcSay("ä»»å‹™å·²å®Œæˆã€‚ä½ å¯ä»¥ç¹¼çºŒå•æˆ‘èˆŠå±±ç·š/å‹èˆˆ/é¾é¨°æ–·æ©‹çš„å•é¡Œï¼ˆå«ï¼Ÿå°±æœƒæŸ¥ RAGï¼‰ï¼Œæˆ–è¼¸å…¥ã€Œæ¸…é™¤è¨˜æ†¶ã€é‡ä¾†ã€‚", true);
      endTurn();
      return;
    }

    endTurn();
  }

  // ===============================
  // Camera upload (with resize)
  // ===============================
  function flash(){
    shutterOverlay.classList.remove('flash-active');
    void shutterOverlay.offsetWidth;
    shutterOverlay.classList.add('flash-active');
  }

  function resizeImageFileToDataURL(file, maxDim = 900, quality = 0.85){
    return new Promise((resolve, reject) => {
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => {
        try{
          const w = img.width, h = img.height;
          const scale = Math.min(1, maxDim / Math.max(w, h));
          const cw = Math.round(w * scale);
          const ch = Math.round(h * scale);

          const canvas = document.createElement('canvas');
          canvas.width = cw; canvas.height = ch;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, cw, ch);

          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          URL.revokeObjectURL(url);
          resolve(dataUrl);
        }catch(err){
          URL.revokeObjectURL(url);
          reject(err);
        }
      };
      img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('Image load failed')); };
      img.src = url;
    });
  }

  cameraBtn.addEventListener('click', () => {
    if(isNpcTyping) return;

    if(gameState !== 3){
      if(gameState < 3) npcSay("ç¾åœ¨é‚„ä¸æ˜¯æ‹ç…§çš„æ™‚å€™ã€‚è«‹å…ˆç”¨æ–‡å­—å’Œæˆ‘ç¢ºèªä»»å‹™ç›®æ¨™ï¼", true);
      if(gameState === 4) npcSay("ä»»å‹™å·²å®Œæˆã€‚ä½ å¯ä»¥ç¹¼çºŒå•æˆ‘å•é¡Œï¼ˆå«ï¼ŸæœƒæŸ¥ RAGï¼‰ï¼Œæˆ–è¼¸å…¥ã€Œæ¸…é™¤è¨˜æ†¶ã€é‡ä¾†ã€‚", true);
      return;
    }
    cameraInput.value = "";
    cameraInput.click();
  });

  cameraInput.addEventListener('change', async () => {
    const file = cameraInput.files && cameraInput.files[0];
    if(!file) return;
    if(gameState !== 3 || isNpcTyping) return;

    isNpcTyping = true;
    flash();

    try{
      const dataUrl = await resizeImageFileToDataURL(file, 900, 0.85);

      addMessage('me', dataUrl, true);
      markProgress("photoSent", true);

      const multimodalMsg = addSystemMessage("ğŸ‘ï¸ Multimodal AI æ­£åœ¨è§£æå½±åƒç‰¹å¾µ...", true);

      setTimeout(() => {
        multimodalMsg.remove();
        addSystemMessage(`âœ… å½±åƒè¾¨è­˜ï¼š${TARGET_LANDMARK} (ä¿¡å¿ƒåº¦ 95%)`);

        setTimeout(() => {
          npcSay(`å¤ªåƒäº†...ï¼é€™çœŸçš„æ˜¯ **${TARGET_LANDMARK}**ï¼æˆ‘ä»¥å‰æ¯å¤©éƒ½æœƒç¶“éé€™è£¡...`, true);
          npcSay(`åŸä¾†ä½ å€‘çš„æ™‚ä»£ï¼Œå®ƒé‚„èƒ½ä»¥å¦ä¸€ç¨®æ–¹å¼è¢«è¨˜å¾—ã€‚`, true);
          npcSay(`ğŸ‰ **æ­å–œï¼** ç²å¾— **èˆŠå±±ç·šæ™‚ç©ºåµæ¢** ç¨±è™Ÿã€‚æ–°çš„ç·šç´¢å·²æ›´æ–°ï¼\n\nï¼ˆæƒ³æŸ¥è³‡æ–™ï¼šç›´æ¥å•æˆ‘ï¼Œæˆ–è¼¸å…¥ RAG:ä½ çš„å•é¡Œï¼‰`, true);

          gameState = 4;
          markProgress("finished", true);
          isNpcTyping = false;
        }, 900);

      }, 1200);

    }catch(e){
      npcSay("ç…§ç‰‡è®€å–å¤±æ•—äº†...è¨Šè™Ÿå¾ˆä¸ç©©ã€‚ä½ å¯ä»¥å†è©¦ä¸€æ¬¡å—ï¼Ÿ", true);
      isNpcTyping = false;
    }
  });

  // ===============================
  // Start
  // ===============================
  startProactiveHints();
  startSignalAcquisition();
</script>
</body>
</html>

