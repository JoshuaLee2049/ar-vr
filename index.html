<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>City RPG: èˆŠå±±ç·šæ™‚ç©ºæ¢éšª - æœ€çµ‚æ•´åˆç‰ˆ</title>

<style>
  body {
    background-color:#000; margin:0;
    font-family:'PingFang TC','Microsoft JhengHei',monospace;
    overflow:hidden; height:100vh;
    display:flex; justify-content:center; align-items:stretch;
  }

  .phone-frame{
    width:100%; max-width:450px; height:100%;
    position:relative; overflow:hidden;
    background:#111;
  }

  /* Phase 1 */
  .signal-overlay{
    position:absolute; inset:0;
    background:repeating-linear-gradient(0deg, rgba(0,0,0,0.15) 1px, transparent 2px);
    pointer-events:none; z-index:100;
    animation: scanline 8s linear infinite;
  }
  .glitch-screen{
    position:absolute; inset:0;
    background:#000; color:#0f0; z-index:50;
    display:flex; flex-direction:column; justify-content:center; align-items:center;
    text-align:center; padding:20px; transition:opacity 1s;
  }
  .glitch-text{
    font-size:1.2em;
    text-shadow:2px 0 red, -2px 0 blue;
    animation: glitch 0.3s cubic-bezier(.25,.46,.45,.94) both infinite;
  }

  /* Phase 2/3 */
  .chat-interface{
    width:100%; height:100%;
    display:flex; flex-direction:column;
    background-image:
      linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)),
      url('https://images.unsplash.com/photo-1517414628890-5348538e8bf0?auto=format&fit=crop&q=80&w=800');
    background-size:cover; background-position:center;
    opacity:0; transition:opacity 1s;
  }
  .header{
    background:rgba(0,0,0,0.8); color:#fff;
    padding:15px; display:flex; align-items:center;
    border-bottom:1px solid #333;
  }
  .chat-area{
    flex:1; padding:20px 12px;
    overflow-y:auto; display:flex; flex-direction:column; gap:18px;
    scroll-behavior:smooth;
  }

  /* Message rows */
  .msg-row{
    display:flex; align-items:flex-end;
    margin-bottom:5px;
    opacity:0; transform:translateY(10px);
    transition:all 0.5s;
  }
  .msg-row.show{ opacity:1; transform:translateY(0); }
  .msg-row.me{ justify-content:flex-end; }
  .msg-row.other{ justify-content:flex-start; }

  .avatar{
    width:42px; height:42px; border-radius:50%;
    border:2px solid #fff; margin-right:10px;
    background-size:cover; filter:sepia(0.3);
    flex-shrink:0;
  }
  .sender-name{
    color:#ccc; font-size:0.8em;
    margin-bottom:4px; margin-left:2px;
    text-shadow:1px 1px 2px black;
  }

  .bubble{
    position:relative; /* è®“å°–è§’å®šä½æ­£ç¢º */
    padding:10px 14px; border-radius:18px;
    font-size:0.95em; line-height:1.5;
    max-width:240px;
    box-shadow:0 2px 4px rgba(0,0,0,0.3);
    word-break:break-word;
  }

  .msg-row.other .bubble{
    background:rgba(255,255,255,0.95); color:#333;
    border-top-left-radius:2px;
  }
  .msg-row.other .bubble::before{
    content:"";
    position:absolute; left:-8px; top:0;
    border-right:12px solid rgba(255,255,255,0.95);
    border-bottom:10px solid transparent;
  }

  .msg-row.me .bubble{
    background:#98e165; color:#000;
    border-top-right-radius:2px;
  }
  .msg-row.me .bubble::before{
    content:"";
    position:absolute; right:-8px; top:0;
    border-left:12px solid #98e165;
    border-bottom:10px solid transparent;
  }

  .meta-info{
    font-size:0.7em;
    color:rgba(255,255,255,0.55);
    margin:0 8px; white-space:nowrap;
  }
  .read-status{ margin-right:6px; opacity:0.9; }

  .ticket-img{
    width:100%;
    border-radius:4px;
    border:2px solid #777;
    filter:sepia(0.8) contrast(1.2);
    display:block;
  }

  /* System card */
  .system-card{
    align-self:center;
    background:rgba(13,100,100,0.7);
    color:#fff;
    padding:5px 15px;
    border-radius:20px;
    font-size:0.75em;
    margin:10px 0;
    border:1px solid rgba(255,255,255,0.3);
    backdrop-filter:blur(4px);
  }
  .thinking-dots::after{
    content:"...";
    display:inline-block;
    overflow:hidden;
    vertical-align:bottom;
    width:0;
    animation:dots 1.2s steps(4,end) infinite;
  }

  /* Input bar */
  .input-bar{
    background:#222; padding:10px;
    border-top:1px solid #444;
    display:flex; align-items:center; gap:10px;
  }
  .icon-btn{
    font-size:1.4em; padding:5px;
    cursor:pointer; color:#ccc;
    user-select:none;
  }
  .text-input{
    flex:1; background:#333; border:none;
    padding:10px 15px; border-radius:20px;
    outline:none; font-size:16px; color:white;
  }
  .send-btn{
    color:#5dade2; font-weight:bold;
    cursor:pointer; border:none; background:none; padding:5px;
  }
  .send-btn:disabled{ opacity:0.4; cursor:not-allowed; }

  /* Flash */
  .shutter-flash{
    position:absolute; inset:0;
    background:#fff; opacity:0;
    pointer-events:none; z-index:999;
  }
  .flash-active{ animation: flashAnim 0.3s ease-out forwards; }

  @keyframes scanline{ 0%{background-position:0% 0%} 100%{background-position:0% 100%} }
  @keyframes glitch{
    0%{transform:translate(0)}
    40%{transform:translate(2px,-2px)}
    80%{transform:translate(-2px,2px)}
    100%{transform:translate(0)}
  }
  @keyframes flashAnim{ 0%{opacity:0} 30%{opacity:0.9} 100%{opacity:0} }
  @keyframes dots{ to{ width:1.2em } }
</style>
</head>

<body>
  <div class="phone-frame">
    <div class="shutter-flash" id="shutterOverlay"></div>
    <div class="signal-overlay"></div>

    <div class="glitch-screen" id="glitchScreen">
      <div style="font-size:3em; margin-bottom:20px;">âš ï¸</div>
      <div class="glitch-text" id="glitchText">é€£ç·šå»ºç«‹ä¸­...<br>æ¥æ”¶åˆ°æœªé »æ®µè¨Šè™Ÿ...</div>
    </div>

    <div class="chat-interface" id="chatInterface">
      <div class="header">
        <div style="flex:1;">ğŸ“¶ ä¸æ˜è¨Šè™Ÿæº</div>
        <div style="font-size:0.8em; color:#e74c3c;">é€£ç·šä¸ç©©å®š</div>
      </div>

      <div class="chat-area" id="chatArea"></div>

      <div class="input-bar">
        <div class="icon-btn" id="cameraBtn">ğŸ“·</div>
        <!-- âœ… çœŸå¯¦ç›¸æ©Ÿ/ç›¸ç°¿ä¸Šå‚³ï¼ˆæ‰‹æ©Ÿå¤šåŠæœƒè·³ç›¸æ©Ÿï¼‰ -->
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">
        <div class="icon-btn">ï¼‹</div>

        <input type="text" class="text-input" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯...">
        <button class="send-btn" id="sendBtn" disabled>å‚³é€</button>
      </div>
    </div>
  </div>

<script>
  // DOM
  const chatArea = document.getElementById('chatArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const cameraBtn = document.getElementById('cameraBtn');
  const cameraInput = document.getElementById('cameraInput');
  const shutterOverlay = document.getElementById('shutterOverlay');
  const glitchScreen = document.getElementById('glitchScreen');
  const chatInterface = document.getElementById('chatInterface');
  const glitchText = document.getElementById('glitchText');

  // 0=æœªé–‹å§‹, 1=é–‹å ´ä¸­, 2=ç­‰å¾…æ–‡å­—ç¢ºèª, 3=ç­‰å¾…æ‹ç…§, 4=å®Œæˆ
  let gameState = 0;
  let isNpcTyping = false;

  // Helpers
  const pad2 = (n) => String(n).padStart(2, '0');

  function getCurrentTime(){
    const now = new Date();
    return `${pad2(now.getHours())}:${pad2(now.getMinutes())}`; // âœ… ä¿®æ­£è‡´å‘½éŒ¯èª¤
  }

  function generateRandomChars(length){
    const chars = "!@#$%^&*()_+-=[]{}|;:,.<>?";
    let result = "";
    for(let i=0;i<length;i++) result += chars.charAt(Math.floor(Math.random()*chars.length));
    return result;
  }

  function scrollToBottom(){ chatArea.scrollTop = chatArea.scrollHeight; }

  function escapeHtml(str){
    return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function formatText(str){
    const safe = escapeHtml(str);
    return safe.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
  }

  // addMessage(type, text, isImage=false, forceNpcName=false)
  function addMessage(type, text, isImage=false, forceNpcName=false){
    const row = document.createElement('div');
    row.className = 'msg-row';
    const time = getCurrentTime();

    let contentHtml;
    if(isImage){
      contentHtml = `<div class="bubble" style="padding:5px;"><img src="${text}" class="ticket-img" alt="image"></div>`;
    }else{
      contentHtml = `<div class="bubble">${formatText(text)}</div>`;
    }

    if(type === 'me'){
      row.classList.add('me');
      row.innerHTML = `
        <div class="meta-info"><span class="read-status">å·²è®€</span><span>${time}</span></div>
        ${contentHtml}
      `;
    }else{
      row.classList.add('other');
      const senderName = forceNpcName ? "ç«™é•· (è¨Šè™Ÿå¾®å¼±)" : "ç«™é•·";
      row.innerHTML = `
        <div class="avatar" style="background-image:url('https://api.dicebear.com/7.x/avataaars/svg?seed=StationMaster');"></div>
        <div style="flex:1;">
          <div class="sender-name">${senderName}</div>
          ${contentHtml}
        </div>
        <div class="meta-info"><span>${time}</span></div>
      `;
    }

    chatArea.appendChild(row);
    void row.offsetWidth;
    row.classList.add('show');
    scrollToBottom();
  }

  function addSystemMessage(text, isThinking=false){
    const div = document.createElement('div');
    div.className = 'system-card' + (isThinking ? ' thinking-dots' : '');
    div.textContent = text;
    chatArea.appendChild(div);
    scrollToBottom();
    return div;
  }

  // Phase 1
  function startSignalAcquisition(){
    gameState = 1;
    const steps = [
      "SYSTEM_OVERRIDE...",
      "æ­£åœ¨æœå°‹ 1935 å¹´é »æ®µ...",
      "è¨Šè™ŸåŒæ­¥ç‡ 48%...",
      "è¨Šè™ŸåŒæ­¥ç‡ 92%...",
      "âš ï¸ åµæ¸¬åˆ°æ±‚æ•‘è¨Šè™Ÿ"
    ];
    let stepIndex = 0;

    const interval = setInterval(() => {
      if(stepIndex < steps.length){
        glitchText.innerHTML = steps[stepIndex] + "<br>" + generateRandomChars(10);
        stepIndex++;
      }else{
        clearInterval(interval);
        setTimeout(() => {
          glitchScreen.style.opacity = '0';
          setTimeout(startPhase2, 1000);
        }, 1000);
      }
    }, 800);
  }

  // Phase 2
  function startPhase2(){
    glitchScreen.style.display = 'none';
    chatInterface.style.opacity = '1';
    sendBtn.disabled = false;
    gameState = 2;

    setTimeout(() => addMessage('other', "æ»‹...æ»‹...è½å¾—åˆ°å—ï¼Ÿæ‹œè¨—ï¼æˆ‘æ˜¯å‹èˆˆè»Šç«™çš„ç«™é•·ï¼Œè¢«å›°åœ¨ 1935 å¹´ï¼", false, true), 500);

    setTimeout(() => {
      addMessage('other', "é€™å¼µæ˜¯æœ€å¾Œä¸€ç­è»Šç¥¨...æŒç¥¨äººå¤±è¹¤äº†ã€‚ä¸Šé¢å¯«è‘—ã€Œè‡ºä¸­ã€ï¼", false, true);
    }, 2000);

    setTimeout(() => {
      addMessage(
        'other',
        "https://images.unsplash.com/photo-1516533075015-a3838415dbc3?auto=format&fit=crop&q=80&w=300",
        true,
        true
      );
    }, 4000);

    setTimeout(() => {
      addMessage('other',
        "ç¾åœ¨çš„è‡ºä¸­...æ˜¯ä¸æ˜¯é•·å¾—ä¸ä¸€æ¨£äº†ï¼Ÿè»Šç¥¨ä¸»äººå¯èƒ½åœ¨é‚£é‚Šã€‚\n" +
        "è«‹ä½ ...ç”¨ä½ å€‘æ™‚ä»£çš„ç›¸æ©Ÿï¼Œæ‹ä¸€å¼µè»Šç¥¨ç›®çš„åœ°ï¼ˆè‡ºä¸­ï¼‰çš„ **åœ°æ¨™** ç…§ç‰‡çµ¦æˆ‘ï¼"
      );
    }, 6000);
  }

  // Text send
  messageInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){
      e.preventDefault();
      handleSend();
    }
  });
  sendBtn.addEventListener('click', handleSend);

  function handleSend(){
    const text = messageInput.value.trim();
    if(!text || isNpcTyping) return;

    addMessage('me', text);
    messageInput.value = '';

    isNpcTyping = true;
    setTimeout(() => processTextLogic(text), 800);
  }

  function processTextLogic(text){
    const endTurn = () => { isNpcTyping = false; };

    if(gameState === 2){
      if(text.includes("è‡ºä¸­") || text.includes("å°ä¸­") || text.includes("åœ°æ¨™") || text.includes("æ‹ç…§") || text.includes("çŸ¥é“äº†")){
        addSystemMessage("âœ… Agent åˆ¤æ–·ï¼šç†è§£ä»»å‹™ç›®æ¨™");
        addMessage('other', "å¾ˆå¥½ï¼è«‹é»æ“Šå·¦ä¸‹è§’çš„ **ğŸ“· ç›¸æ©ŸæŒ‰éˆ•**ï¼Œæ‹ä¸€å¼µè‡ºä¸­çš„åœ°æ¨™ç…§ç‰‡å‚³çµ¦æˆ‘ï¼", false, true);
        gameState = 3;
        endTurn();
        return;
      }

      if(text.includes("åœ°éœ‡") || text.includes("1935")){
        const thinkingMsg = addSystemMessage("ğŸ” RAG è³‡æ–™åº«æª¢ç´¢ä¸­ï¼š1935 åœ°éœ‡ç´€éŒ„...", true);
        setTimeout(() => {
          thinkingMsg.remove();
          addMessage('other', "é‚£å ´éœ‡å‹•...æˆ‘æ°¸ç”Ÿé›£å¿˜ã€‚æ ¹æ“šç´€éŒ„ï¼Œé¾é¨°æ–·æ©‹ä¹Ÿæ˜¯é‚£æ™‚å€™éœ‡æ¯€çš„ã€‚ä½†è»Šç¥¨çš„ç·šç´¢åœ¨è‡ºä¸­ï¼åˆ¥åˆ†å¿ƒï¼");
          endTurn();
        }, 1800);
        return;
      }

      addMessage('other', "æˆ‘è½ä¸å¤ªæ¸…æ¥š...è¨Šè™Ÿå¹²æ“¾å¾ˆåš´é‡ã€‚å°ˆæ³¨åœ¨è»Šç¥¨å’Œç›®çš„åœ°ï¼");
      endTurn();
      return;
    }

    if(gameState === 3){
      addMessage('other', "æˆ‘ç¾åœ¨éœ€è¦çš„æ˜¯ã€Œå½±åƒè­‰æ“šã€ï¼è«‹ç”¨ç›¸æ©Ÿæ‹ä¸‹ä¾†ï¼");
      endTurn();
      return;
    }

    endTurn();
  }

  // ---- Real camera upload (with resize) ----
  function flash(){
    shutterOverlay.classList.remove('flash-active');
    void shutterOverlay.offsetWidth;
    shutterOverlay.classList.add('flash-active');
  }

  function resizeImageFileToDataURL(file, maxDim = 900, quality = 0.85){
    return new Promise((resolve, reject) => {
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => {
        try{
          const w = img.width, h = img.height;
          const scale = Math.min(1, maxDim / Math.max(w, h));
          const cw = Math.round(w * scale);
          const ch = Math.round(h * scale);

          const canvas = document.createElement('canvas');
          canvas.width = cw; canvas.height = ch;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, cw, ch);

          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          URL.revokeObjectURL(url);
          resolve(dataUrl);
        }catch(err){
          URL.revokeObjectURL(url);
          reject(err);
        }
      };
      img.onerror = () => {
        URL.revokeObjectURL(url);
        reject(new Error('Image load failed'));
      };
      img.src = url;
    });
  }

  cameraBtn.addEventListener('click', () => {
    if(isNpcTyping) return;

    if(gameState !== 3){
      if(gameState < 3) addMessage('other', "ç¾åœ¨é‚„ä¸æ˜¯æ‹ç…§çš„æ™‚å€™ã€‚è«‹å…ˆç”¨æ–‡å­—å’Œæˆ‘ç¢ºèªä»»å‹™ç›®æ¨™ï¼");
      if(gameState === 4) addMessage('other', "ä»»å‹™å·²å®Œæˆã€‚æ–°çš„æŒ‡ä»¤åœ¨è¨Šæ¯ç´€éŒ„è£¡ã€‚");
      return;
    }

    cameraInput.value = ""; // å…è¨±é€£é¸åŒä¸€å¼µä¹Ÿæœƒè§¸ç™¼ change
    cameraInput.click();
  });

  cameraInput.addEventListener('change', async () => {
    const file = cameraInput.files && cameraInput.files[0];
    if(!file) return;

    if(gameState !== 3 || isNpcTyping) return;

    isNpcTyping = true;
    flash();

    try{
      const dataUrl = await resizeImageFileToDataURL(file, 900, 0.85);

      // âœ… é¡¯ç¤ºä½¿ç”¨è€…ç…§ç‰‡æ³¡æ³¡
      addMessage('me', dataUrl, true);

      const multimodalMsg = addSystemMessage("ğŸ‘ï¸ Multimodal AI æ­£åœ¨è§£æå½±åƒç‰¹å¾µ...", true);

      // ï¼ˆå‰ç«¯ç´” HTML/JS å…ˆåšåŠ‡æƒ…æ¨¡æ“¬ï¼šè‹¥è¦çœŸè¾¨è­˜éœ€æ¥å¾Œç«¯æˆ– APIï¼‰
      setTimeout(() => {
        multimodalMsg.remove();
        addSystemMessage("âœ… å½±åƒè¾¨è­˜ï¼šè‡ºä¸­ç«è»Šç«™èˆŠç«™ (ä¿¡å¿ƒåº¦ 95%)");

        setTimeout(() => {
          addMessage('other', "å•Šï¼é€™æ˜¯...è‡ºä¸­è»Šç«™ï¼å®ƒé•·å¾—å’Œä»¥å‰ä¸å¤ªä¸€æ¨£äº†ï¼ä¸éé€™å€‹å»ºç¯‰é¢¨æ ¼æˆ‘èªå¾—å‡ºä¾†ï¼");
          addMessage('other', "æ ¹æ“šæˆ‘çš„ç´€éŒ„ï¼Œè‡ºä¸­è»Šç«™çš„è¨­è¨ˆå¸«æ˜¯è¾°é‡é‡‘å¾çš„å­¸ç”Ÿã€‚ä½ æ‰¾åˆ°äº†è»Šç¥¨ä¸»äººçš„ç·šç´¢äº†ï¼");
          addMessage('other', "ğŸ‰ **æ­å–œï¼** ç²å¾— **æ™‚ç©ºåµæ¢** ç¨±è™Ÿã€‚æ–°çš„ç·šç´¢å·²æ›´æ–°ï¼");
          gameState = 4;
          isNpcTyping = false;
        }, 900);

      }, 1600);

    }catch(e){
      addMessage('other', "ç…§ç‰‡è®€å–å¤±æ•—äº†...è¨Šè™Ÿå¾ˆä¸ç©©ã€‚ä½ å¯ä»¥å†è©¦ä¸€æ¬¡å—ï¼Ÿ");
      isNpcTyping = false;
    }
  });

  // Start
  startSignalAcquisition();
</script>
</body>
</html>
