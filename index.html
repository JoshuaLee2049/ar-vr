<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>City RPG: èˆŠå±±ç·šæ™‚ç©ºæ¢éšª - æœ€çµ‚æ•´åˆç‰ˆ</title>
<style>
  /* --- åŸºç¤è¨­å®š --- */
  body { background-color: #000; margin: 0; font-family: 'PingFang TC', 'Microsoft JhengHei', monospace; overflow: hidden; height: 100vh; display: flex; justify-content: center; }

  .phone-frame { 
    width: 100%; max-width: 450px; height: 100%; position: relative; overflow: hidden;
    background: #111;
  }
  
  /* --- Phase 1: é›œè¨Šé–‹å ´ (Glitch Screen) --- */
  .signal-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.15) 1px, transparent 2px);
    pointer-events: none; z-index: 100; animation: scanline 8s linear infinite;
  }
  .glitch-screen {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: black; color: #0f0; z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center;
    text-align: center; padding: 20px; transition: opacity 1s;
  }
  .glitch-text {
    font-size: 1.2em; text-shadow: 2px 0 red, -2px 0 blue; animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite;
  }

  /* --- Phase 2 & 3: èŠå¤©ä»‹é¢ (Line Style) --- */
  .chat-interface {
    width: 100%; height: 100%; display: flex; flex-direction: column;
    background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1517414628890-5348538e8bf0?auto=format&fit=crop&q=80&w=800'); 
    background-size: cover; background-position: center; opacity: 0; transition: opacity 1s;
  }
  .header { background: rgba(0,0,0,0.8); color: #fff; padding: 15px; display: flex; align-items: center; border-bottom: 1px solid #333; }
  .chat-title { flex: 1; font-weight: bold; }
  .chat-area { flex: 1; padding: 20px 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 18px; scroll-behavior: smooth; }
  
  /* è¨Šæ¯æ¨£å¼ */
  .msg-row { display: flex; align-items: flex-start; margin-bottom: 5px; opacity: 0; transform: translateY(10px); transition: all 0.5s; }
  .msg-row.show { opacity: 1; transform: translateY(0); }
  .msg-row.me { justify-content: flex-end; }

  .avatar { width: 42px; height: 42px; border-radius: 50%; border: 2px solid #fff; margin-right: 10px; background-size: cover; filter: sepia(0.3); flex-shrink: 0;}
  .sender-name { color: #ccc; font-size: 0.8em; margin-bottom: 4px; margin-left: 2px; text-shadow: 1px 1px 2px black;}
  .bubble { padding: 10px 14px; border-radius: 18px; font-size: 0.95em; line-height: 1.5; max-width: 240px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
  
  .msg-row.other .bubble { background: rgba(255,255,255,0.95); color: #333; border-top-left-radius: 2px; }
  .msg-row.other .bubble::before { content: ""; position: absolute; left: -8px; top: 0; border-top: 0 solid transparent; border-right: 12px solid rgba(255,255,255,0.95); border-bottom: 10px solid transparent; }
  
  .msg-row.me .bubble { background: #98e165; color: #000; border-top-right-radius: 2px; }
  .msg-row.me .bubble::before { content: ""; position: absolute; right: -8px; top: 0; border-top: 0 solid transparent; border-left: 12px solid #98e165; border-bottom: 10px solid transparent; }

  /* é“å…·ï¼šè»Šç¥¨ */
  .ticket-img { width: 100%; border-radius: 4px; border: 2px solid #777; filter: sepia(0.8) contrast(1.2); }
  
  /* ç³»çµ±æç¤ºå¡ç‰‡ (RAG/ä»»å‹™) */
  .system-card { align-self: center; background: rgba(13, 100, 100, 0.7); color: #fff; padding: 5px 15px; border-radius: 20px; font-size: 0.75em; margin: 10px 0; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(4px); }
  .thinking-dots::after { content: ' .'; animation: dots 1.5s steps(5, end) infinite; }
  
  /* è¼¸å…¥å€ */
  .input-bar { background: #222; padding: 10px; border-top: 1px solid #444; display: flex; align-items: center; gap: 10px; }
  .icon-btn { font-size: 1.4em; padding: 5px; cursor: pointer; color: #ccc; }
  .text-input { flex: 1; background: #333; border: none; padding: 10px 15px; border-radius: 20px; outline: none; font-size: 16px; color: white; }
  .send-btn { color: #5dade2; font-weight: bold; cursor: pointer; border: none; background: none; padding: 5px; }

  /* ç›¸æ©Ÿé–ƒå…‰ç‰¹æ•ˆ */
  .shutter-flash {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 999;
  }
  .flash-active { animation: flashAnim 0.3s ease-out forwards; }
  
  /* å‹•ç•« Keyframes */
  @keyframes scanline { 0% { background-position: 0% 0%; } 100% { background-position: 0% 100%; } }
  @keyframes glitch { 0% { transform: translate(0); } 40% { transform: translate(2px, -2px); } 80% { transform: translate(-2px, 2px); } 100% { transform: translate(0); } }
  @keyframes flashAnim { 0% { opacity: 0; } 30% { opacity: 0.9; } 100% { opacity: 0; } }
  @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 100% { content: ''; }}
</style>
</head>
<body>

<div class="phone-frame">
  <div class="shutter-flash" id="shutterOverlay"></div>
  <div class="signal-overlay"></div>

  <div class="glitch-screen" id="glitchScreen">
    <div style="font-size: 3em; margin-bottom: 20px;">âš ï¸</div>
    <div class="glitch-text" id="glitchText">é€£ç·šå»ºç«‹ä¸­...<br>æ¥æ”¶åˆ°æœªé »æ®µè¨Šè™Ÿ...</div>
  </div>

  <div class="chat-interface" id="chatInterface">
    <div class="header">
      <div style="flex:1;">ğŸ“¶ ä¸æ˜è¨Šè™Ÿæº</div>
      <div style="font-size: 0.8em; color: #e74c3c;">é€£ç·šä¸ç©©å®š</div>
    </div>

    <div class="chat-area" id="chatArea">
    </div>

    <div class="input-bar">
      <div class="icon-btn" id="cameraBtn">ğŸ“·</div>
      <div class="icon-btn">ï¼‹</div>
      <input type="text" class="text-input" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯...">
      <button class="send-btn" id="sendBtn" disabled>å‚³é€</button>
    </div>
  </div>
</div>

<script>
  // --- DOM å…ƒç´ èˆ‡ç‹€æ…‹ ---
  const chatArea = document.getElementById('chatArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const cameraBtn = document.getElementById('cameraBtn');
  const shutterOverlay = document.getElementById('shutterOverlay');
  const glitchScreen = document.getElementById('glitchScreen');
  const chatInterface = document.getElementById('chatInterface');
  const glitchText = document.getElementById('glitchText');

  // 0=æœªé–‹å§‹, 1=é–‹å ´ä¸­, 2=ç­‰å¾…è»Šç¥¨ä¸»äººè³‡è¨Š, 3=ç­‰å¾…æ‹ç…§(å¤šæ¨¡æ…‹é©—è­‰)
  let gameState = 0; 
  let isNpcTyping = false; 

  // --- è¼”åŠ©å‡½å¼ ---

  function getCurrentTime() {
    const now = new Date();
    return `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
  }
  function generateRandomChars(length) {
    let chars = "!@#$%^&*()_+-=[]{}|;:,.<>?";
    let result = "";
    for (let i = 0; i < length; i++) { result += chars.charAt(Math.floor(Math.random() * chars.length)); }
    return result;
  }
  function scrollToBottom() { chatArea.scrollTop = chatArea.scrollHeight; }

  // ç™¼é€è¨Šæ¯ (Type: 'me' æˆ– 'other')
  function addMessage(type, text, isImage = false, forceNpcName = false) {
    const row = document.createElement('div');
    row.className = `msg-row`;
    const time = getCurrentTime();

    let contentHtml = `<div class="bubble">${text}</div>`;
    if (isImage) {
      contentHtml = `<div class="bubble" style="padding: 5px;"><img src="${text}" class="ticket-img"></div>`;
    }

    if (type === 'me') {
      row.classList.add('me');
      row.innerHTML = `<div class="meta-info"><span class="read-status">å·²è®€</span><span>${time}</span></div><div class="msg-content">${contentHtml}</div>`;
    } else {
      row.classList.add('other');
      const senderName = forceNpcName ? "ç«™é•· (è¨Šè™Ÿå¾®å¼±)" : "ç«™é•·";
      row.innerHTML = `<div class="avatar" style="background-image: url('https://api.dicebear.com/7.x/avataaars/svg?seed=StationMaster&top=hat');"></div><div style="flex:1;"><div class="sender-name">${senderName}</div>${contentHtml}</div><div class="meta-info"><span>${time}</span></div>`;
    }

    chatArea.appendChild(row);
    void row.offsetWidth; // ç¢ºä¿å‹•ç•«è§¸ç™¼
    row.classList.add('show');
    scrollToBottom();
  }

  // é¡¯ç¤ºç³»çµ±æç¤º
  function addSystemMessage(text, isThinking = false) {
    const div = document.createElement('div');
    div.className = 'system-card' + (isThinking ? ' thinking-dots' : '');
    div.textContent = text;
    chatArea.appendChild(div);
    scrollToBottom();
    return div;
  }

  // --- Phase 1: å•Ÿå‹•é–‹å ´å‹•ç•« ---
  function startSignalAcquisition() {
    gameState = 1; // è¨­ç½®ç‚ºé–‹å ´ä¸­
    let steps = [
      "SYSTEM_OVERRIDE...", "æ­£åœ¨æœå°‹ 1935 å¹´é »æ®µ...", "è¨Šè™ŸåŒæ­¥ç‡ 48%...", "è¨Šè™ŸåŒæ­¥ç‡ 92%...", "âš ï¸ åµæ¸¬åˆ°æ±‚æ•‘è¨Šè™Ÿ"
    ];
    let stepIndex = 0;
    let interval = setInterval(() => {
      if (stepIndex < steps.length) {
        glitchText.innerHTML = steps[stepIndex] + "<br>" + generateRandomChars(10);
        stepIndex++;
      } else {
        clearInterval(interval);
        setTimeout(() => {
          glitchScreen.style.opacity = '0';
          setTimeout(startPhase2, 1000); // 1ç§’å¾Œåˆ‡æ›åˆ°èŠå¤©
        }, 1000);
      }
    }, 800);
  }

  // --- Phase 2: ä»»å‹™æ´¾ç™¼ (Agent) ---
  function startPhase2() {
    glitchScreen.style.display = 'none';
    chatInterface.style.opacity = '1';
    sendBtn.disabled = false; // è§£é–å‚³é€æŒ‰éˆ•
    gameState = 2; // é€²å…¥ç­‰å¾…è³‡è¨Šéšæ®µ

    // åŠ‡æœ¬
    setTimeout(() => addMessage("other", "æ»‹...æ»‹...è½å¾—åˆ°å—ï¼Ÿæ‹œè¨—ï¼æˆ‘æ˜¯å‹èˆˆè»Šç«™çš„ç«™é•·ï¼Œè¢«å›°åœ¨ 1935 å¹´ï¼", false, true), 500);
    setTimeout(() => addMessage("other", "é€™å¼µæ˜¯æœ€å¾Œä¸€ç­è»Šç¥¨...æŒç¥¨äººå¤±è¹¤äº†ã€‚ä¸Šé¢å¯«è‘—ã€Œè‡ºä¸­ã€ï¼", false, true), 2000);
    setTimeout(() => {
      addMessage("other", "https://images.unsplash.com/photo-1516533075015-a3838415dbc3?auto=format&fit=crop&q=80&w=300", 'other', true); // æ¨¡æ“¬è»Šç¥¨åœ–ç‰‡
      addMessage("other", "ç¾åœ¨çš„è‡ºä¸­...æ˜¯ä¸æ˜¯é•·å¾—ä¸ä¸€æ¨£äº†ï¼Ÿè»Šç¥¨ä¸»äººå¯èƒ½åœ¨é‚£é‚Šã€‚è«‹ä½ ...ç”¨ä½ å€‘æ™‚ä»£çš„ç›¸æ©Ÿï¼Œæ‹ä¸€å¼µè»Šç¥¨ç›®çš„åœ°ï¼ˆè‡ºä¸­ï¼‰çš„ **åœ°æ¨™** ç…§ç‰‡çµ¦æˆ‘ï¼");
    }, 4000);
  }

  // --- Phase 3: å¯¦å¢ƒè§£è¬ (Multimodal + RAG + Agent) ---

  // è™•ç†æ–‡å­—è¼¸å…¥ (RAG)
  messageInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSend(); });
  sendBtn.addEventListener('click', handleSend);
  
  function handleSend() {
    const text = messageInput.value.trim();
    if (!text || isNpcTyping) return;
    
    addMessage('me', text);
    messageInput.value = '';
    
    // é€²å…¥ AI é‚è¼¯åˆ¤æ–·
    isNpcTyping = true;
    setTimeout(() => { processTextLogic(text); }, 1500);
  }

  function processTextLogic(text) {
    if (gameState === 2) {
      if (text.includes("è‡ºä¸­") || text.includes("å°ä¸­") || text.includes("åœ°æ¨™") || text.includes("æ‹ç…§")) {
        addSystemMessage("âœ… Agent åˆ¤æ–·ï¼šç†è§£ä»»å‹™ç›®æ¨™");
        addMessage("å¾ˆå¥½ï¼æˆ‘çŸ¥é“ä½ å€‘ç¾åœ¨çš„æŠ€è¡“å¾ˆå²å®³ã€‚è«‹é»æ“Šå·¦ä¸‹è§’çš„ **ğŸ“· ç›¸æ©ŸæŒ‰éˆ•**ï¼Œæ‹ä¸€å¼µè‡ºä¸­çš„åœ°æ¨™ç…§ç‰‡å‚³çµ¦æˆ‘ï¼", 'other');
        gameState = 3; // é€²å…¥ç­‰å¾…æ‹ç…§ç‹€æ…‹
      } else if (text.includes("åœ°éœ‡") || text.includes("1935")) {
        // RAG æ¨¡æ“¬
        const thinkingMsg = addSystemMessage("ğŸ” RAG è³‡æ–™åº«æª¢ç´¢ä¸­ï¼š1935 åœ°éœ‡ç´€éŒ„...", true);
        setTimeout(() => {
          thinkingMsg.remove();
          addMessage("other", "é‚£å ´éœ‡å‹•...æˆ‘æ°¸ç”Ÿé›£å¿˜ã€‚æ ¹æ“šç´€éŒ„ï¼Œé¾é¨°æ–·æ©‹ä¹Ÿæ˜¯é‚£æ™‚å€™éœ‡æ¯€çš„ã€‚ä½†è»Šç¥¨çš„ç·šç´¢åœ¨è‡ºä¸­ï¼åˆ¥åˆ†å¿ƒï¼");
        }, 3000);
      } else {
        addMessage("æˆ‘è½ä¸å¤ªæ¸…æ¥š...è¨Šè™Ÿå¹²æ“¾å¾ˆåš´é‡ã€‚å°ˆæ³¨åœ¨è»Šç¥¨å’Œç›®çš„åœ°ï¼", 'other');
      }
    }
    isNpcTyping = false;
  }

  // è™•ç†æ‹ç…§ (Multimodal)
  cameraBtn.addEventListener('click', () => {
    if (gameState !== 3 || isNpcTyping) return;
    
    // é–ƒå…‰å‹•ç•«
    shutterOverlay.classList.remove('flash-active');
    void shutterOverlay.offsetWidth;
    shutterOverlay.classList.add('flash-active');
    
    isNpcTyping = true;
    
    setTimeout(() => {
      // æ¨¡æ“¬ä¸Šå‚³è‡ºä¸­åœ°æ¨™ (ä¾‹å¦‚ï¼šè‡ºä¸­ç«è»Šç«™)
      addMessage('me', 'ğŸ“· å·²å‚³é€ç…§ç‰‡');
      
      const multimodalMsg = addSystemMessage("ğŸ‘ï¸ Multimodal AI æ­£åœ¨è§£æå½±åƒç‰¹å¾µ...", true);

      setTimeout(() => {
        multimodalMsg.remove();
        addSystemMessage("âœ… å½±åƒè¾¨è­˜ï¼šè‡ºä¸­ç«è»Šç«™èˆŠç«™ (ä¿¡å¿ƒåº¦ 95%)");
        
        // Agent æ ¹æ“šçµæœç”ŸæˆåŠ‡æœ¬
        setTimeout(() => {
          addMessage("other", "å•Šï¼é€™æ˜¯...è‡ºä¸­è»Šç«™ï¼å®ƒé•·å¾—å’Œä»¥å‰ä¸å¤ªä¸€æ¨£äº†ï¼ä¸éé€™å€‹å»ºç¯‰é¢¨æ ¼æˆ‘èªå¾—å‡ºä¾†ï¼");
          addMessage("other", "æ ¹æ“šæˆ‘çš„ç´€éŒ„ï¼Œè‡ºä¸­è»Šç«™çš„è¨­è¨ˆå¸«æ˜¯è¾°é‡é‡‘å¾çš„å­¸ç”Ÿã€‚ä½ æ‰¾åˆ°äº†è»Šç¥¨ä¸»äººçš„ç·šç´¢äº†ï¼");
          addMessage("other", "ğŸ‰ **æ­å–œï¼** ç²å¾— **æ™‚ç©ºåµæ¢** ç¨±è™Ÿã€‚æ–°çš„ç·šç´¢å·²æ›´æ–°ï¼");
          gameState = 4; // ä»»å‹™å®Œæˆ
        }, 1500);
      }, 3000); // æ¨¡æ“¬è§£ææ™‚é–“
    }, 400);
  });

  // --- å•Ÿå‹•ç¨‹åº ---
  startSignalAcquisition();

</script>

</body>
</html>
